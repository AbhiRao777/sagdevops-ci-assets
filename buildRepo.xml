<?xml version="1.0"?>
<project name="Repo" basedir=".">

	<condition property="useLocalRepository">
		<equals arg1="${config.fbr.type}" arg2="local" />
	</condition>

	<condition property="useArtifactoryRepository">
		<equals arg1="${config.fbr.type}" arg2="artifactory" />
	</condition>

	<target name="bda.repo.prepareFbrForDeployment" depends="bda.repo.prepareLocalFbrForDeployment, bda.repo.prepareArtifactoryFbrForDeployment">
		<log msg="Using fbr repository of type ${config.fbr.type}" />
	</target>

	<target name="bda.repo.prepareLocalFbrForDeployment" if="useLocalRepository" depends="">
		<description>Deploy project.</description>
		<property name="fbrRepoDir" value="${buildOutputDir}" />
	</target>

	<target name="bda.repo.prepareArtifactoryFbrForDeployment" if="useArtifactoryRepository" depends="">
		<description>Deploy project.</description>
		<property name="moduleName" value="${bda.projectName}" />
		<property name="baseRevision" value="${config.build.version}.${env.BUILD_NUMBER}" />
		<property name="artifactName" value="${moduleName}-${baseRevision}.zip" />
		<property name="artifactAsZip" location="${config.tmpdir}/${artifactName}" />
		<property name="unzipDir" location="${config.build.buildStorageDir}/${moduleName}-${baseRevision}"/>
		<antcall target="common.deldir">
			<param name="dir" value="${unzipDir}"/>
		</antcall>
		<antcall target="common.create_dir">
			<param name="dir" value="${unzipDir}"/>
		</antcall>
		<unzip dest="${unzipDir}">
			<fileset dir="${env.WORKSPACE}" includes="**/${artifactName}"></fileset>
		</unzip>
		<property name="fbrRepoDir" value="${unzipDir}" />
	</target>

	<target name="bda.repo.prepareArtifactoryDownloadSpec">
		<property name="moduleName" value="${bda.projectName}" />
		<property name="baseRevision" value="${config.build.version}.${env.BUILD_NUMBER}" />
		<property name="artifactName" value="${moduleName}-${baseRevision}.zip" />
		<property name="artifactAsZip" location="${config.tmpdir}/${artifactName}" />

		<antcall target="bda.repo.createArtifactFileSpec">
			<param name="type" value="download" />
		</antcall>
	</target>

	<target name="bda.repo.processBuildOutput" depends="bda.repo.processBuildOutputForArtifactory, bda.repo.processBuildOutputForLocalRepo">
		<log msg="Post processing of build output finished" />
	</target>

	<target name="bda.repo.processBuildOutputForLocalRepo" if="useLocalRepository" depends="">
		<log msg="Using local repository, no processing of build output at '${buildOutputDir}' necessary" />
	</target>

	<target name="bda.repo.processBuildOutputForArtifactory" if="useArtifactoryRepository" depends="">
		<log msg="Using Artifactory as repository, pushing contents from ${buildOutputDir} to configured Artifactory server" />
		<property name="moduleName" value="${bda.projectName}" />
		<property name="baseRevision" value="${config.build.version}.${env.BUILD_NUMBER}" />
		<property name="artifactName" value="${moduleName}-${baseRevision}.zip" />
		<property name="artifactAsZip" location="${config.tmpdir}/${artifactName}" />

		<antcall target="bda.repo.zipOutputDir" />

		<antcall target="bda.repo.createArtifactFileSpec">
			<param name="type" value="upload" />
		</antcall>
	</target>

	<target name="bda.repo.zipOutputDir">
		<log msg="Creating FBR zip ${artifactAsZip} from directory '${buildOutputDir}' " />
		<zip destfile="${artifactAsZip}" basedir="${buildOutputDir}">
			<fileset includes="**/*" dir="${buildOutputDir}">
			</fileset>
		</zip>
	</target>

	<target name="bda.repo.createArtifactFileSpec">
		<property name="groovyScript.CreateArtifactoryFileSpec" location="resources/scripts/ArtifactoryFileSpec.groovy" />
		<log msg="Creating Artifactory file spec '${config.build.artifactory.fileSpecName}' for ${type}" />
		<groovy src="${groovyScript.CreateArtifactoryFileSpec}">
			<arg line="-outputDir ${env.WORKSPACE}/" />
			<arg line="-fileSpecName ${type}.${config.build.artifactory.fileSpecName}" />
			<arg line="-pathToFbrZip ${artifactAsZip}" />
			<arg line="-org ${config.build.artifactory.path.org}" />
			<arg line="-moduleName ${moduleName}" />
			<arg line="-baseRevision ${baseRevision}" />
			<arg line="-artifactoryRepository ${config.build.artifactory.repository}" />
			<arg line="-type ${type}" />
		</groovy>
	</target>

</project>
