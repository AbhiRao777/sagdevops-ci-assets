<?xml version="1.0"?>

<project default="bda.deployer.startDeployer" basedir="." name="build_Deployer">

	<property name="projectName" value="BDA_${bda.targetEnv}_${bda.projectName}" />
	<property name="projectAutomatorDefinition" location="${config.tmpdir}/${projectName}_PA_template.definition.xml" />

	<condition property="isWindows">
		<os family="windows" />
	</condition>

	<condition property="isUnix">
		<os family="unix" />
	</condition>

	<target name="bda.deployer.initWindows" if="isWindows">
		<property name="deployerExecutable" value="Deployer.bat" />
		<property name="deployerAutomatorExecutable" value="projectautomator.bat" />
	</target>

	<target name="bda.deployer.initUnix" if="isUnix">
		<property name="deployerExecutable" value="Deployer.sh" />
		<property name="deployerAutomatorExecutable" value="projectautomatorUnix.sh" />
	</target>


	<target name="bda.deployer.initDeployer" depends="bda.deployer.cleanup, bda.deployer.initWindows, bda.deployer.initUnix">
		<!--
		    If antcontrib has not been included by parent script already, uncomment these lines...
			<taskdef classpathref="bda.classpath" resource="net/sf/antcontrib/antlib.xml" />
			<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpathref="bda.classpath" />
		-->
		<log msg="Init build Deployer. Properties: with project name='${projectName}' and repository='${fbrRepoName}'." />
		<log msg="Target Environment='${bda.targetEnv}'" />
		<log msg="Project name='${projectName}'" />
		<log msg="Repository Name='${fbrRepoName}'." />
		<log msg="Repository location='${fbrRepoDir}'"/>
	</target>

	<target name="bda.deployer.parseFBR" description="Parse the file based repository directory and search for composites">
		<log msg="Using FBR: ${fbrRepoDir}" />
		<groovy>
			import groovy.xml.DOMBuilder
	    	import groovy.xml.dom.DOMCategory
			// we only support packages, processes and MWS projects currently...
			def packages = []
			def bpms = []
			def mws = []
	
			new File(properties.'fbrRepoDir').eachDirRecurse() { dir ->
			    dir.eachFileMatch(~/.*.acdl/) { file ->			
					def doc  = groovy.xml.DOMBuilder.parse(new FileReader(file))
			    	def asset_composite = doc.documentElement
			    	use (DOMCategory) {
						def implementation_generic = asset_composite.'implementation.generic'
						def type=implementation_generic.'@type'[0]
						def displayName = asset_composite.'@displayName'
					    def name = asset_composite.'@name'
			
					
				    	println "found acdl ${file} of type=${type} with name=${name} and displayName=${displayName}"
			
						 if(type == 'bpmprocess') {
				            bpms.add([name: name, displayName: displayName])
				        } else if (type == 'ispackage' || type == 'isconfiguration') {
				            packages.add([name: name, displayName: name])
				        } else if (type == 'war') {
				            mws.add([name: name, displayName: displayName])
				        } else if (type == 'pdp') {
							mws.add([name: name, displayName: displayName])
				        } else if (type == 'cdp') {
							mws.add([name: name, displayName: displayName])
						} 
					}
				}
			}
			
			def xmlFile = properties.'projectAutomatorDefinition'
			def repoName = properties.'fbrRepoName'
		    println "parsing xml project definition file '${xmlFile}' in order to add ACDLs from FBR to it"
			def xml = new XmlParser().parse(xmlFile)
			
			def deploymentSet = xml.Projects.Project.DeploymentSet[0]
			if (!packages.empty) {								
				packages.each() {
					def newComposite = new Node(null, 'Composite', [name:"${it.name}", displayName:"${it.name}", srcAlias:"${repoName}", type:'IS'])
					//def newComposite = new Node(null, 'Composite', [name:"${it.name}", srcAlias:"${repoName}", type:'IS'])
					deploymentSet.append(newComposite)
				}
			}
			if (!bpms.empty) {
				bpms.each() {
						def newComposite = new Node(null, 'Composite', [displayName:"${it.displayName}", name:"${it.name}", srcAlias:"${repoName}", type:'BPM'])
						deploymentSet.append(newComposite)
				}
			}
			if (!mws.empty) {
				mws.each() {
					def newComposite = new Node(null, 'Composite', [displayName:"${it.displayName}", name:"${it.name}", srcAlias:"${repoName}", type:'MWS'])
					deploymentSet.append(newComposite)
				}			
			}	
			def output = properties.'projectAutomatorDefinition'
			XmlNodePrinter np = new XmlNodePrinter(new PrintWriter(new FileWriter(output)))
			np.preserveWhitespace = true
			np.print(xml)
			println "Finished adding composites to project automator template '${output}'"
		</groovy>
	</target>

	<target name="bda.deployer.createProjectAutomatorTemplate" depends="">
		<property name="groovyScript.CreateProjectAutomatorTemplate" location="resources/ProjectAutomator/CreateProjectAutomatorTemplate.groovy" />
		<log msg="Creating project definition file '${projectAutomatorDefinition}' using environments defined in '${environmentsDefinition}'. Groovy script: '${groovyScript.CreateProjectAutomatorTemplate}'" />
		<groovy src="${groovyScript.CreateProjectAutomatorTemplate}">
			<arg line="-r ${fbrRepoDir}" />
			<arg line="-p ${projectName}" />
			<arg line="-f ${projectAutomatorDefinition}" />
			<arg line="-t ${bda.targetEnv}" />
			<arg line="-d ${config.deployer.deployerHost}:${config.deployer.deployerPort}" />
			<arg line="-u ${config.deployer.deployerUsername}" />
			<arg line="-s ${config.deployer.deployerPassword}" />
			<arg line="-e ${environmentsDefinition}" />
			<arg line="-repoName ${fbrRepoName}" />
		</groovy>
	</target>

	<target name="bda.deployer.cleanup">
		<delete file="${projectAutomatorDefinition}">
		</delete>
	</target>

	<target name="bda.deployer.startDeployer" depends="bda.deployer.setupDeployer, bda.deployer.deployDeployer" description="creates the deployer project and invokes Deployer for execution">

	</target>


	<target name="bda.deployer.setupDeployer" depends="bda.deployer.initDeployer, bda.deployer.createProjectAutomatorTemplate, bda.deployer.parseFBR, bda.deployer.execProjectAutomator, bda.deployer.importVarSubDeployer" description="creates the deployer project">

	</target>

	<target name="bda.deployer.execProjectAutomator">
		<path id="path.projectdefinition">
			<pathelement location="${projectAutomatorDefinition}" />
		</path>
		<pathconvert refid="path.projectdefinition" property="path.projectdefinition.file">
		</pathconvert>

		<property name="output" value="${config.deployer.deployerInstallationPath}/logs/CLI.log" />

		<exec resultproperty="paResult" failonerror="false" dir="${config.deployer.deployerInstallationPath}" executable="${config.deployer.deployerInstallationPath}/${deployerAutomatorExecutable}" output="${output}">
			<arg value="${path.projectdefinition.file}" />
		</exec>

		<if>
			<not>
				<equals arg1="${paResult}" arg2="0" />
			</not>
			<then>
				<loadfile property="CLI.log" srcFile="${output}" />
				<log msg="Project Automator returned an error. Output of file '${output}'" level="ERROR" />
				<log msg="${CLI.log}" level="ERROR" />
				<fail message="Project Automator returned an error." />
			</then>
		</if>
	</target>


	<condition property="doVarSub">
		<equals arg1="${config.deployer.doVarSub}" arg2="true" />
	</condition>

	<target name="bda.deployer.importVarSubDeployer" depends="bda.deployer.createVarSub" if="doVarSub" description="the entry point for the varsub implementation">
		<!-- check if the var sub file contains at least one deployment set, i.e. the varsub is not empty -->
		<xmltask source="${varsubfile.path}">
			<copy path="count(//DeploementSet)" property="countDeploementSet" />
		</xmltask>
		<if>
			<and>
				<available file="${varsubfile.path}" type="file" />
				<not>
					<equals arg1="0" arg2="${countDeploementSet}" />
				</not>
			</and>
			<then>
				<property name="deployerReplicateInboundDir" location="${config.deployer.deployerInstallationPath}/../replicate/inbound"/>
				<log msg="At least one varsub was created, copy file '${varsubfile.path}' to Deployer replicate inbound dir at '${deployerReplicateInboundDir}'." />
				<copy file="${varsubfile.path}" todir="${deployerReplicateInboundDir}" />
				<log msg="-- variable substitution will be used: '${varsubfile.file}'" />

				<property name="output" value="${config.deployer.deployerInstallationPath}/logs/CLI.log" />
				<exec executable="${config.deployer.deployerInstallationPath}/${deployerExecutable}" dir="${config.deployer.deployerInstallationPath}" output="${output}" resultproperty="importVarsubReturnCode" failonerror="false">
					<arg value="--import" />
					<arg value="-varsub" />
					<arg line="-vsFile ${varsubfile.file}" />
					<arg line="-map DeploymentMap" />
					<arg line="-project ${projectName}" />
					<arg line="-host ${config.deployer.deployerHost}" />
					<arg line="-port ${config.deployer.deployerPort}" />
					<arg line="-user ${config.deployer.deployerUsername}" />
					<arg line="-pwd ${config.deployer.deployerPassword}" />
				</exec>
				<log msg="Importing the varsub file '${varsubfile.file}' restulted in return code ${importVarsubReturnCode}. See logs at '${output}'." />
				<if>
					<equals arg1="${importVarsubReturnCode}" arg2="8" />
					<then>
						<loadfile property="CLI.log" srcFile="${output}" />
						<log msg="Deployer varsub import returned an error. Output of file '${output}'" level="ERROR" />
						<log msg="${CLI.log}" level="ERROR" />
						<fail message="Error when importing the varsub file ${varsubfile.file}." />
					</then>
				</if>
			</then>
			<else>
				<log msg="-- no variable substitution will be used." />
			</else>
		</if>
	</target>

	<target name="bda.deployer.deployDeployer">
		<log msg="-- Invoking Deployer executable '${config.deployer.deployerInstallationPath}/${deployerExecutable}' with parameters: -project ${projectName}, -dc myDeployment, -host ${config.deployer.deployerHost}, -port ${config.deployer.deployerPort}, -user ${config.deployer.deployerUsername}" />
		<property name="output" value="${config.deployer.deployerInstallationPath}/logs/CLI.log" />
		<exec resultproperty="deployerResult" executable="${config.deployer.deployerInstallationPath}/${deployerExecutable}" dir="${config.deployer.deployerInstallationPath}" failonerror="false" output="${output}">
			<arg value="--deploy" />
			<arg line="-project ${projectName}" />
			<arg line="-dc Deployment" />
			<arg line="-host ${config.deployer.deployerHost}" />
			<arg line="-port ${config.deployer.deployerPort}" />
			<arg line="-user ${config.deployer.deployerUsername}" />
			<arg line="-pwd ${config.deployer.deployerPassword}" />
			<arg value="-force" />
		</exec>
		<if>
			<and>
				<isset property="deployerResult" />
				<equals arg1="${deployerResult}" arg2="8" />
			</and>
			<then>
				<log msg="Deployer returned an error result code: '${deployerResult}'. Output of file '${output}':" level="ERROR" />
				<loadfile property="CLI.log" srcFile="${output}" />
				<log msg="${CLI.log}" level="ERROR" />
				<fail message="Deployer returned an error result code: '${deployerResult}'." />
			</then>
			<else>
				<log msg="Deployer succeeded with result code '${deployerResult}'." level="INFO" />
			</else>
		</if>
	</target>


	<target name="bda.deployer.createVarSub" if="doVarSub">
		<log msg="Creating variable substitution for target environment '${bda.targetEnv}'" />

		<property name="varsubfile.file" value="${projectName}.vs" />
		<!-- store temp varsub files in a special vs tmp dir -->
		<property name="varsubTmpDir" value="${config.tmpdir}/vs/${bda.targetEnv}" />
		<antcall target="common.create_dir">
			<param name="overwrite" value="false" />
			<param name="dir" value="${varsubTmpDir}" />
		</antcall>
		<property name="varsubfile.path" location="${varsubTmpDir}/${varsubfile.file}" />

		<delete file="${varsubfile.path}" />

		<property name="groovyScript.CreateVarSub" location="resources/vs/CreateVarSub.groovy" />
		<property name="varsubDir" location="${config.deployer.varsubDir}" />
		<log msg="Calling '${groovyScript.CreateVarSub}' to create varsub file" />
		<groovy src="${groovyScript.CreateVarSub}">
			<arg line="-a ${projectAutomatorDefinition}" />
			<arg line="-p ${projectName}" />
			<arg line="-f ${varsubfile.path}" />
			<arg line="-t ${bda.targetEnv}" />
			<arg line="-vs ${varsubDir}" />
		</groovy>

	</target>
</project>
