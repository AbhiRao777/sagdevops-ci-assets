<?xml version="1.0"?>
<project name="Build and Deploy Solution" default="" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

	<property name="ivy.jar.file" location="${lib.dir}/ivy.jar" />
	<property name="ivysettings.xml" location="resources/ivy/ivysettings.xml" />
	<property name="ivy.xml" location="resources/ivy/ivy.xml" />

	<target name="bda.dependencies.downloadIvy" if="useIvy" unless="skip.download">
		<property name="ivy.install.version" value="2.4.0" />
		<property name="ivy.downloadUrl" value="https://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar" />
		<echo message="installing ivy... Download from '${ivy.downloadUrl}', storing jar in '${ivy.jar.file}'." />
		<get src="${ivy.downloadUrl}" dest="${ivy.jar.file}" usetimestamp="true" />
	</target>

	<target name="bda.dependencies.installIvy" if="useIvy" depends="bda.dependencies.downloadIvy">
		<description>Download and store ivy.jar locally</description>
		<path id="ivy.lib.path">
			<fileset dir="${lib.dir}" includes="ivy.jar" />
		</path>
		<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path" />
	</target>

	<target name="bda.dependencies.getJars" if="useIvy" depends="bda.dependencies.installIvy">
		<echo message="Suing ivy.settings '${ivysettings.xml}' and ivy.xml '${ivy.xml}' to resolve dependeant jars from public repositories..." />
		<ivy:settings file="${ivysettings.xml}" id="ivy.settings" />
		<ivy:resolve file="${ivy.xml}" settingsRef="ivy.settings" />
	</target>

	<condition property="useIvy">
		<equals arg1="${config.libs.resolve}" arg2="ivy" />
	</condition>

	<target name="bda.dependencies.fileset.local" unless="useIvy">
		<description>Returns a fileset pointing to lib/ext</description>
		<property name="lib.ext.dir" location="${lib.dir}/ext" />
		<echo>Using local jars located in directory '${lib.ext.dir}'.</echo>
		<fileset dir="${lib.ext.dir}" includes="*.jar" id="dependencies.fileset" />
	</target>

	<target name="bda.dependencies.fileset.ivy" if="useIvy" depends="bda.dependencies.getJars">
		<description>downloads ivy jar, then resolves all necessary jars by using the resources/ivy.ivy.xml dependency declaration</description>
		<echo>Using ivy to download necessary jars as specified in the '${ivy.xml}' file.</echo>
		<ivy:cachefileset setid="dependencies.fileset" settingsRef="ivy.settings" />
	</target>

	<target name="bda.dependencies.fileset" depends="bda.dependencies.fileset.ivy, bda.dependencies.fileset.local" description="Either downloads ivy jar, then resolves all necessary jars by using the resources/ivy.ivy.xml dependency declaration, or use locally stored jars">
		<echo>Referencing jars as defined by property 'config.libs.resolve=${config.libs.resolve}'</echo>
	</target>
</project>